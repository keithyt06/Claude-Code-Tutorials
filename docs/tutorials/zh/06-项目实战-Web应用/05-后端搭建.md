# æ¨¡å— 5: åç«¯æœåŠ¡å™¨æ­å»º

> ä½¿ç”¨ Node.js å’Œ Express æ„å»º RESTful API

## å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æ¨¡å—å,ä½ å°†èƒ½å¤Ÿ:
- æ­å»º Express.js æœåŠ¡å™¨
- è®¾è®¡ RESTful API è·¯ç”±
- é›†æˆ SQLite æ•°æ®åº“
- åˆ›å»ºæ•°æ®æ¨¡å‹
- å¤„ç† API è¯·æ±‚å’Œå“åº”

## æ¦‚è¿°

åœ¨æœ¬æ¨¡å—ä¸­,æˆ‘ä»¬å°†ä¸º Todo App Pro æ„å»ºåç«¯æœåŠ¡å™¨ã€‚æˆ‘ä»¬å°†åˆ›å»ºå¤„ç†ä»»åŠ¡ç®¡ç†çš„ RESTful API å¹¶é›†æˆ SQLite æ•°æ®åº“ã€‚

## 1. Express æœåŠ¡å™¨è®¾ç½®

**server/index.js**:
```javascript
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// ä¸­é—´ä»¶
app.use(cors({
    origin: process.env.CLIENT_URL || 'http://localhost:5500',
    credentials: true
}));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static(path.join(__dirname, '../client')));

// è¯·æ±‚æ—¥å¿—
app.use((req, res, next) => {
    console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
    next();
});

// å¥åº·æ£€æŸ¥
app.get('/api/health', (req, res) => {
    res.json({
        status: 'OK',
        message: 'æœåŠ¡å™¨è¿è¡Œæ­£å¸¸',
        timestamp: new Date().toISOString()
    });
});

// å¯¼å…¥è·¯ç”±
const taskRoutes = require('./routes/tasks');
const authRoutes = require('./routes/auth');

// ä½¿ç”¨è·¯ç”±
app.use('/api/tasks', taskRoutes);
app.use('/api/auth', authRoutes);

// é”™è¯¯å¤„ç†
app.use((err, req, res, next) => {
    console.error('é”™è¯¯:', err);
    res.status(err.status || 500).json({
        error: {
            message: err.message || 'å†…éƒ¨æœåŠ¡å™¨é”™è¯¯',
            status: err.status || 500
        }
    });
});

// 404 å¤„ç†
app.use((req, res) => {
    res.status(404).json({
        error: { message: 'è·¯ç”±æœªæ‰¾åˆ°', status: 404 }
    });
});

// å¯åŠ¨æœåŠ¡å™¨
app.listen(PORT, () => {
    console.log(`
ğŸš€ æœåŠ¡å™¨è¿è¡Œä¸­!
ğŸ“¡ API: http://localhost:${PORT}/api
ğŸŒ å‰ç«¯: http://localhost:${PORT}
ğŸ“Š å¥åº·æ£€æŸ¥: http://localhost:${PORT}/api/health
    `);
});

module.exports = app;
```

## 2. æ•°æ®åº“è®¾ç½®

**server/database.js**:
```javascript
const Database = require('better-sqlite3');
const path = require('path');

const dbPath = process.env.DB_PATH || path.join(__dirname, '../database/tasks.db');
const db = new Database(dbPath);

db.pragma('foreign_keys = ON');

function initializeDatabase() {
    // ç”¨æˆ·è¡¨
    db.exec(`
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            email TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `);

    // ä»»åŠ¡è¡¨
    db.exec(`
        CREATE TABLE IF NOT EXISTS tasks (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            title TEXT NOT NULL,
            description TEXT,
            due_date TEXT,
            priority TEXT DEFAULT 'medium',
            category TEXT DEFAULT 'personal',
            completed BOOLEAN DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
        )
    `);

    console.log('âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
}

initializeDatabase();

module.exports = db;
```

## 3. ä»»åŠ¡è·¯ç”±

**server/routes/tasks.js**:
```javascript
const express = require('express');
const router = express.Router();
const db = require('../database');

// è·å–æ‰€æœ‰ä»»åŠ¡
router.get('/', (req, res) => {
    try {
        const { category, completed, priority } = req.query;
        let query = 'SELECT * FROM tasks WHERE 1=1';
        const params = [];

        if (category) {
            query += ' AND category = ?';
            params.push(category);
        }

        if (completed !== undefined) {
            query += ' AND completed = ?';
            params.push(completed === 'true' ? 1 : 0);
        }

        if (priority) {
            query += ' AND priority = ?';
            params.push(priority);
        }

        query += ' ORDER BY created_at DESC';

        const tasks = db.prepare(query).all(...params);
        res.json({ success: true, data: tasks });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

// åˆ›å»ºä»»åŠ¡
router.post('/', (req, res) => {
    try {
        const { title, description, dueDate, priority, category } = req.body;

        if (!title) {
            return res.status(400).json({
                success: false,
                error: 'ä»»åŠ¡æ ‡é¢˜æ˜¯å¿…éœ€çš„'
            });
        }

        const stmt = db.prepare(`
            INSERT INTO tasks (user_id, title, description, due_date, priority, category)
            VALUES (1, ?, ?, ?, ?, ?)
        `);

        const result = stmt.run(title, description, dueDate, priority, category);
        const task = db.prepare('SELECT * FROM tasks WHERE id = ?').get(result.lastInsertRowid);

        res.status(201).json({ success: true, data: task });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

// æ›´æ–°ä»»åŠ¡
router.put('/:id', (req, res) => {
    try {
        const { id } = req.params;
        const { title, description, dueDate, priority, category, completed } = req.body;

        const stmt = db.prepare(`
            UPDATE tasks
            SET title = COALESCE(?, title),
                description = COALESCE(?, description),
                due_date = COALESCE(?, due_date),
                priority = COALESCE(?, priority),
                category = COALESCE(?, category),
                completed = COALESCE(?, completed),
                updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        `);

        stmt.run(title, description, dueDate, priority, category, completed, id);
        const task = db.prepare('SELECT * FROM tasks WHERE id = ?').get(id);

        res.json({ success: true, data: task });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

// åˆ é™¤ä»»åŠ¡
router.delete('/:id', (req, res) => {
    try {
        const { id } = req.params;
        const stmt = db.prepare('DELETE FROM tasks WHERE id = ?');
        const result = stmt.run(id);

        if (result.changes === 0) {
            return res.status(404).json({
                success: false,
                error: 'ä»»åŠ¡æœªæ‰¾åˆ°'
            });
        }

        res.json({ success: true, message: 'ä»»åŠ¡å·²åˆ é™¤' });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

module.exports = router;
```

## 4. API å®¢æˆ·ç«¯

**client/js/api.js**:
```javascript
const API = {
    baseURL: 'http://localhost:3000/api',

    async request(endpoint, options = {}) {
        const url = `${this.baseURL}${endpoint}`;
        const config = {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        };

        try {
            const response = await fetch(url, config);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error?.message || 'è¯·æ±‚å¤±è´¥');
            }

            return data;
        } catch (error) {
            console.error('API é”™è¯¯:', error);
            throw error;
        }
    },

    // ä»»åŠ¡ç›¸å…³
    async getTasks(filters = {}) {
        const params = new URLSearchParams(filters);
        return this.request(`/tasks?${params}`);
    },

    async createTask(taskData) {
        return this.request('/tasks', {
            method: 'POST',
            body: JSON.stringify(taskData)
        });
    },

    async updateTask(id, updates) {
        return this.request(`/tasks/${id}`, {
            method: 'PUT',
            body: JSON.stringify(updates)
        });
    },

    async deleteTask(id) {
        return this.request(`/tasks/${id}`, {
            method: 'DELETE'
        });
    }
};
```

## å…³é”®è¦ç‚¹

1. **RESTful API** - éµå¾ª REST è®¾è®¡åŸåˆ™
2. **æ•°æ®åº“é›†æˆ** - ä½¿ç”¨ SQLite æŒä¹…åŒ–æ•°æ®
3. **é”™è¯¯å¤„ç†** - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
4. **API å®¢æˆ·ç«¯** - å‰ç«¯å°è£… API è°ƒç”¨
5. **å®‰å…¨æ€§** - è¾“å…¥éªŒè¯å’Œé”™è¯¯å¤„ç†

## ä¸‹ä¸€æ­¥

ğŸ‘‰ **[æ¨¡å— 6: ç”¨æˆ·è®¤è¯](./06-ç”¨æˆ·è®¤è¯.md)** - å®ç°ç”¨æˆ·ç™»å½•æ³¨å†Œ

---

ğŸ“š **è¿”å›**: [ç¬¬å…­è¯¾æ¦‚è¿°](./index.md)
