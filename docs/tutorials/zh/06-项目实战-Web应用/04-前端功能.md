# æ¨¡å— 4: å‰ç«¯åŠŸèƒ½å®ç°

> ä½¿ç”¨ JavaScript è®©ç•Œé¢å……æ»¡æ´»åŠ›

## å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æ¨¡å—å,ä½ å°†èƒ½å¤Ÿ:
- å®ç°ä»»åŠ¡ CRUD æ“ä½œ
- ä½¿ç”¨æœ¬åœ°å­˜å‚¨è¿›è¡Œæ•°æ®æŒä¹…åŒ–
- å¤„ç†è¡¨å•éªŒè¯
- åˆ›å»ºåŠ¨æ€ UI äº¤äº’
- ç®¡ç†åº”ç”¨çŠ¶æ€

## æ¦‚è¿°

åœ¨æœ¬æ¨¡å—ä¸­,æˆ‘ä»¬å°†ä¸º Todo App Pro æ·»åŠ  JavaScript åŠŸèƒ½,ä½¿å…¶å®Œå…¨äº¤äº’ã€‚æˆ‘ä»¬å°†å®ç°ä»»åŠ¡ç®¡ç†ã€æœ¬åœ°å­˜å‚¨å’Œç”¨æˆ·äº¤äº’ã€‚

## 1. ä»»åŠ¡æ•°æ®æ¨¡å‹

### åˆ›å»º Task ç±»

**client/js/task.js**:
```javascript
/**
 * Task ç±»
 * è¡¨ç¤ºå•ä¸ªä»»åŠ¡åŠå…¶æ‰€æœ‰å±æ€§
 */
class Task {
    constructor(title, description = '', dueDate = null, priority = 'medium', category = 'personal') {
        this.id = this.generateId();
        this.title = title;
        this.description = description;
        this.dueDate = dueDate;
        this.priority = priority; // 'low', 'medium', 'high'
        this.category = category;
        this.completed = false;
        this.createdAt = new Date().toISOString();
        this.updatedAt = new Date().toISOString();
    }

    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    toggleComplete() {
        this.completed = !this.completed;
        this.updatedAt = new Date().toISOString();
    }

    update(updates) {
        Object.assign(this, updates);
        this.updatedAt = new Date().toISOString();
    }

    isOverdue() {
        if (!this.dueDate || this.completed) return false;
        return new Date(this.dueDate) < new Date();
    }

    getFormattedDueDate() {
        if (!this.dueDate) return 'æ— åˆ°æœŸæ—¥æœŸ';
        
        const date = new Date(this.dueDate);
        const today = new Date();
        
        if (date.toDateString() === today.toDateString()) {
            return 'ä»Šå¤©';
        }
        
        return date.toLocaleDateString('zh-CN');
    }

    static fromJSON(data) {
        const task = new Task(data.title);
        Object.assign(task, data);
        return task;
    }
}
```

## 2. æœ¬åœ°å­˜å‚¨ç®¡ç†

**client/js/storage.js**:
```javascript
const StorageManager = {
    STORAGE_KEY: 'todo_app_tasks',

    getTasks() {
        const data = localStorage.getItem(this.STORAGE_KEY);
        return data ? JSON.parse(data).map(t => Task.fromJSON(t)) : [];
    },

    saveTasks(tasks) {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(tasks));
    },

    addTask(task) {
        const tasks = this.getTasks();
        tasks.push(task);
        this.saveTasks(tasks);
        return task;
    },

    updateTask(id, updates) {
        const tasks = this.getTasks();
        const task = tasks.find(t => t.id === id);
        if (task) {
            task.update(updates);
            this.saveTasks(tasks);
        }
        return task;
    },

    deleteTask(id) {
        let tasks = this.getTasks();
        tasks = tasks.filter(t => t.id !== id);
        this.saveTasks(tasks);
    }
};
```

## 3. UI ç®¡ç†

**client/js/ui.js**:
```javascript
const UIManager = {
    renderTasks(tasks) {
        const taskList = document.getElementById('taskList');
        taskList.innerHTML = '';

        if (tasks.length === 0) {
            taskList.innerHTML = '<p class="loading">æš‚æ— ä»»åŠ¡</p>';
            return;
        }

        tasks.forEach(task => {
            const taskCard = this.createTaskCard(task);
            taskList.appendChild(taskCard);
        });
    },

    createTaskCard(task) {
        const card = document.createElement('div');
        card.className = `task-card priority-${task.priority} ${task.completed ? 'completed' : ''}`;
        card.dataset.id = task.id;

        card.innerHTML = `
            <div class="task-header">
                <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                <label class="task-title">${this.escapeHTML(task.title)}</label>
            </div>
            <p class="task-description">${this.escapeHTML(task.description || '')}</p>
            <div class="task-meta">
                <span class="task-category">${task.category}</span>
                <span class="task-priority priority-${task.priority}">${this.getPriorityText(task.priority)}</span>
                <span class="task-date">ğŸ“… ${task.getFormattedDueDate()}</span>
            </div>
            <div class="task-actions">
                <button class="btn-icon btn-edit" title="ç¼–è¾‘">âœï¸</button>
                <button class="btn-icon btn-delete" title="åˆ é™¤">ğŸ—‘ï¸</button>
            </div>
        `;

        return card;
    },

    showModal() {
        document.getElementById('taskModal').classList.add('active');
    },

    hideModal() {
        document.getElementById('taskModal').classList.remove('active');
    },

    escapeHTML(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },

    getPriorityText(priority) {
        const texts = { low: 'ä½', medium: 'ä¸­', high: 'é«˜' };
        return texts[priority] || priority;
    }
};
```

## 4. åº”ç”¨ä¸»é€»è¾‘

**client/js/app.js**:
```javascript
const TodoApp = {
    tasks: [],
    currentFilter: 'all',
    currentSort: 'date',

    init() {
        this.loadTasks();
        this.setupEventListeners();
        this.render();
    },

    loadTasks() {
        this.tasks = StorageManager.getTasks();
    },

    setupEventListeners() {
        // æ·»åŠ ä»»åŠ¡æŒ‰é’®
        document.getElementById('addTaskBtn').addEventListener('click', () => {
            UIManager.showModal();
        });

        // ä»»åŠ¡è¡¨å•æäº¤
        document.getElementById('taskForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleTaskSubmit();
        });

        // ä»»åŠ¡åˆ—è¡¨äº‹ä»¶å§”æ‰˜
        document.getElementById('taskList').addEventListener('click', (e) => {
            const taskCard = e.target.closest('.task-card');
            if (!taskCard) return;

            if (e.target.classList.contains('task-checkbox')) {
                this.toggleTask(taskCard.dataset.id);
            } else if (e.target.classList.contains('btn-delete')) {
                this.deleteTask(taskCard.dataset.id);
            } else if (e.target.classList.contains('btn-edit')) {
                this.editTask(taskCard.dataset.id);
            }
        });

        // è¿‡æ»¤æŒ‰é’®
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.setFilter(e.target.dataset.filter);
            });
        });

        // æ’åº
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            this.currentSort = e.target.value;
            this.render();
        });

        // æœç´¢
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.searchTasks(e.target.value);
        });
    },

    handleTaskSubmit() {
        const formData = {
            title: document.getElementById('taskTitle').value,
            description: document.getElementById('taskDescription').value,
            category: document.getElementById('taskCategory').value,
            priority: document.getElementById('taskPriority').value,
            dueDate: document.getElementById('taskDueDate').value
        };

        const task = new Task(
            formData.title,
            formData.description,
            formData.dueDate,
            formData.priority,
            formData.category
        );

        StorageManager.addTask(task);
        this.loadTasks();
        this.render();
        UIManager.hideModal();
        document.getElementById('taskForm').reset();
    },

    toggleTask(id) {
        const task = this.tasks.find(t => t.id === id);
        if (task) {
            task.toggleComplete();
            StorageManager.saveTasks(this.tasks);
            this.render();
        }
    },

    deleteTask(id) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—?')) {
            StorageManager.deleteTask(id);
            this.loadTasks();
            this.render();
        }
    },

    setFilter(filter) {
        this.currentFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });
        this.render();
    },

    searchTasks(query) {
        const filtered = this.tasks.filter(task => 
            task.title.toLowerCase().includes(query.toLowerCase())
        );
        UIManager.renderTasks(this.sortTasks(filtered));
    },

    sortTasks(tasks) {
        return tasks.sort((a, b) => {
            if (this.currentSort === 'priority') {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            } else if (this.currentSort === 'date') {
                return new Date(b.createdAt) - new Date(a.createdAt);
            }
            return a.title.localeCompare(b.title);
        });
    },

    getFilteredTasks() {
        let filtered = this.tasks;

        if (this.currentFilter === 'active') {
            filtered = filtered.filter(t => !t.completed);
        } else if (this.currentFilter === 'completed') {
            filtered = filtered.filter(t => t.completed);
        }

        return this.sortTasks(filtered);
    },

    render() {
        const filtered = this.getFilteredTasks();
        UIManager.renderTasks(filtered);
    }
};

// åˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', () => {
    TodoApp.init();
});
```

## å…³é”®è¦ç‚¹

1. **æ•°æ®æ¨¡å‹** - ä½¿ç”¨ç±»å°è£…ä»»åŠ¡é€»è¾‘
2. **æœ¬åœ°å­˜å‚¨** - æŒä¹…åŒ–ä»»åŠ¡æ•°æ®
3. **äº‹ä»¶å§”æ‰˜** - é«˜æ•ˆå¤„ç†åŠ¨æ€å…ƒç´ 
4. **çŠ¶æ€ç®¡ç†** - é›†ä¸­ç®¡ç†åº”ç”¨çŠ¶æ€
5. **ç”¨æˆ·åé¦ˆ** - æä¾›å³æ—¶çš„è§†è§‰åé¦ˆ

## ä¸‹ä¸€æ­¥

ğŸ‘‰ **[æ¨¡å— 5: åç«¯æœåŠ¡å™¨æ­å»º](./05-åç«¯æ­å»º.md)** - æ„å»º API æœåŠ¡å™¨

---

ğŸ“š **è¿”å›**: [ç¬¬å…­è¯¾æ¦‚è¿°](./index.md)
