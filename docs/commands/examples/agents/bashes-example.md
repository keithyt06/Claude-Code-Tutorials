# `/bashes` 命令示例

## 概述
`/bashes` 命令显示和管理后台 shell 进程，允许您监控长时间运行的命令、查看其输出并在需要时终止它们。

## 何时使用
- 监控长时间运行的构建
- 跟踪测试执行
- 观察后台进程
- 调试挂起的命令
- 管理多个并发任务
- 查看已完成进程的输出

## 示例用法

### 场景1：列出后台进程

```
User: /bashes

Claude Code: 后台 Shell 进程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

活动进程：

┌────┬───────────────────┬──────────┬──────────┬────────┐
│ ID │ 命令              │ 状态     │ 运行时间 │ PID    │
├────┼───────────────────┼──────────┼──────────┼────────┤
│ 1  │ npm test          │ 运行中   │ 00:45    │ 12345  │
│ 2  │ npm run build     │ 运行中   │ 02:15    │ 12346  │
│ 3  │ docker compose up │ 运行中   │ 15:30    │ 12347  │
└────┴───────────────────┴──────────┴──────────┴────────┘

已完成进程：

┌────┬───────────────┬──────────┬──────────┐
│ ID │ 命令          │ 退出代码 │ 持续时间 │
├────┼───────────────┼──────────┼──────────┤
│ 4  │ npm install   │ 0        │ 01:23    │
│ 5  │ git clone ... │ 0        │ 00:34    │
└────┴───────────────┴──────────┴──────────┘

选项：
[1] 查看进程输出
[2] 终止进程
[3] 等待进程完成
[4] 清除已完成进程
[5] 刷新列表

选择选项（1-5）：
```

### 场景2：查看进程输出

```
User: /bashes output 1

Claude Code: Shell 进程 #1：npm test
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

命令：npm test
状态：运行中
运行时间：00:47
PID：12345

实时输出：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

> myapp@1.0.0 test
> jest

PASS  src/auth/login.test.ts
  ✓ 应该验证正确凭据（23ms）
  ✓ 应该拒绝无效凭据（18ms）
  ✓ 应该处理缺失字段（12ms）

PASS  src/api/users.test.ts
  ✓ 应该获取用户列表（45ms）
  ✓ 应该创建新用户（34ms）
  ✓ 应该更新用户（28ms）

当前运行：src/utils/calculator.test.ts
  ✓ add 函数正常工作
  ✓ subtract 函数正常工作
  测试中：multiply 函数...

[按 Ctrl+C 停止跟踪输出]

User: [Ctrl+C]

Claude Code: 停止输出流。
进程 #1 仍在后台运行。

使用以下命令再次查看输出：
/bashes output 1
```

### 场景3：终止进程

```
User: /bashes kill 2

Claude Code: 终止进程 #2
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

命令：npm run build
状态：运行中
PID：12346
运行时间：02:17

确定要终止此进程吗？（y/n）

User: y

Claude Code: 正在终止进程 12346...

✓ 进程已终止
✓ 资源已清理

最后输出：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
> Building for production
> Compiling TypeScript files...
> [41/235 files compiled]
[进程被用户终止]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 后台进程管理

### 启动后台进程

```
User: 在后台运行完整测试套件

Claude Code: 正在启动后台测试...

命令：npm test -- --coverage
进程 ID：#6
PID：12350

✓ 进程在后台启动
✓ 输出将被捕获

监控进度：
/bashes output 6

检查状态：
/bashes

[测试在后台运行，同时您可以继续工作]

User: 现在让我修复登录 bug

Claude Code: [您可以在后台测试运行时继续工作]
```

### 等待进程完成

```
User: /bashes wait 1

Claude Code: 等待进程 #1 完成...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

命令：npm test
状态：运行中
已运行：03:45

[显示进度]

测试套件：█████████████████████░░░ 89%
已用时间：03:45
估计剩余：00:30

[进程完成]

✓ 进程完成成功！

最终结果：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
测试套件：45通过，0失败，总共45个
测试：234通过，0失败，总共234个
覆盖率：94.5%
持续时间：04:12

退出代码：0（成功）
```

## 输出监控

### 持续跟踪输出

```
User: /bashes tail 1

Claude Code: 跟踪进程 #1 输出（实时）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[自动更新输出流]

01:23:45  PASS  src/auth.test.ts
01:23:46  PASS  src/api.test.ts
01:23:48  PASS  src/utils.test.ts
01:23:51  运行中：src/components/Button.test.tsx
01:23:53    ✓ 应该使用正确文本渲染
01:23:54    ✓ 应该处理点击事件
01:23:55  PASS  src/components/Button.test.tsx
01:23:57  运行中：src/components/Form.test.tsx

[当新行到达时自动滚动]

[按 q 退出，Ctrl+C 停止进程]
```

### 查看历史输出

```
User: /bashes output 4

Claude Code: Shell 进程 #4：npm install（已完成）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

命令：npm install
状态：已完成
退出代码：0（成功）
持续时间：01:23
开始时间：2025-01-08 14:30:00
结束时间：2025-01-08 14:31:23

完整输出：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

> npm install

added 234 packages, removed 5 packages, and changed 12 packages in 1m 23s

45 packages are looking for funding
  run `npm fund` for details

审计了 1453 packages
发现 0 个漏洞

[完整输出已捕获]

导出输出：
/bashes export 4 output.log
```

### 过滤输出

```
User: /bashes output 1 --filter "FAIL\|ERROR"

Claude Code: 进程 #1 输出（仅显示 FAIL/ERROR）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

已过滤：仅显示包含 "FAIL" 或 "ERROR" 的行

输出：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[未找到匹配行]

所有测试通过 - 无失败或错误！✓

显示全部输出：
/bashes output 1
```

## 进程控制

### 暂停/恢复

```
User: /bashes pause 3

Claude Code: 暂停进程 #3
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

命令：docker compose up
PID：12347

发送 SIGSTOP 信号...
✓ 进程已暂停

进程已冻结但未终止。

恢复：
/bashes resume 3

终止：
/bashes kill 3

User: /bashes resume 3

Claude Code: ✓ 进程已恢复
继续执行
```

### 向进程发送信号

```
User: /bashes signal 1 SIGTERM

Claude Code: 向进程 #1 发送信号
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

命令：npm test
PID：12345
信号：SIGTERM（优雅终止）

发送信号...
✓ 已发送信号

等待进程响应...
✓ 进程优雅终止
退出代码：143

清理已完成。
```

## 多进程管理

### 终止多个进程

```
User: /bashes

[显示5个运行中的进程]

User: /bashes kill 1 2 3

Claude Code: 终止多个进程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

将终止：
- 进程 #1：npm test（PID 12345）
- 进程 #2：npm run build（PID 12346）
- 进程 #3：docker compose up（PID 12347）

继续？（y/n）

User: y

Claude Code: 正在终止进程...

进程 #1：✓ 已终止
进程 #2：✓ 已终止
进程 #3：✓ 已终止

所有进程已停止。
```

### 终止全部

```
User: /bashes kill-all

Claude Code: 终止所有后台进程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

警告：这将终止所有5个运行中的进程：
- npm test（03:45 运行中）
- npm run build（05:12 运行中）
- docker compose up（1:23:45 运行中）
- jest --watch（00:15 运行中）
- npm run dev（02:30 运行中）

您确定要终止所有进程吗？（y/n）

User: y

Claude Code: 正在终止所有进程...

✓ 5个进程已终止
✓ 资源已清理

无运行中的后台进程。
```

## 输出导出

### 导出到文件

```
User: /bashes export 4 install-log.txt

Claude Code: 导出进程 #4 输出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

进程：npm install（已完成）
输出大小：4.2 KB
目标：install-log.txt

✓ 输出已导出

文件位置：
/Users/dev/myproject/install-log.txt

包含：
- 完整 stdout
- 完整 stderr
- 时间戳
- 退出代码
- 持续时间
```

### 导出所有进程

```
User: /bashes export-all logs/

Claude Code: 导出所有进程输出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

目标目录：logs/

正在导出：
✓ 进程 #1 → logs/process-1-npm-test.log
✓ 进程 #2 → logs/process-2-npm-build.log
✓ 进程 #3 → logs/process-3-docker-compose.log
✓ 进程 #4 → logs/process-4-npm-install.log
✓ 进程 #5 → logs/process-5-git-clone.log

已导出5个文件
总大小：1.2 MB

查看摘要：
logs/summary.txt
```

## 进程通知

### 完成时通知

```
User: /bashes notify 1

Claude Code: 启用进程 #1 通知
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

命令：npm test
当前状态：运行中（已运行03:45）

通知启用：
[✓] 进程完成时
[✓] 进程失败时
[ ] 进程输出错误时
[ ] 特定输出模式

✓ 监控进程 #1

[继续工作]

[45分钟后...]

[桌面通知出现]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Claude Code

进程完成：npm test
✓ 成功退出（代码0）
持续时间：04:12
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

User: /bashes output 1

[查看最终输出]
```

### 错误时通知

```
User: /bashes notify 2 --on-error

Claude Code: 启用进程 #2 错误通知
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

仅在进程失败或输出错误时通知。

监控：
[✓] 退出代码 != 0
[✓] Stderr 输出
[✓] 崩溃/挂起

[后台监控]

[如果检测到错误]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️  Claude Code 警告

进程 #2 失败：npm run build
错误：构建失败，有错误
退出代码：1

查看详情：/bashes output 2
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 进程统计

### 查看详细统计信息

```
User: /bashes stats 1

Claude Code: 进程 #1 统计信息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

命令：npm test
PID：12345
状态：运行中

时间：
开始时间：2025-01-08 14:30:00
运行时间：04:12:34
估计完成：14:35 (约5分钟)

资源：
CPU：45.2%
内存：234 MB
磁盘 I/O：12.3 MB 读取，5.6 MB 写入

输出：
Stdout：125 KB
Stderr：0 KB
总行数：2,345

网络：
已发送：0 KB
已接收：0 KB
```

### 全部进程摘要

```
User: /bashes stats

Claude Code: 所有进程统计信息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

活动进程：3
已完成进程：2
失败进程：0

总资源使用：
CPU：89.4%
内存：567 MB
磁盘：已读取23.4 MB，已写入12.1 MB

最老进程：docker compose up（15:45:23）
最新进程：npm test（00:02:15）

总运行时间：16:03:12
```

## 进程搜索

### 按命令搜索

```
User: /bashes find npm

Claude Code: 搜索进程：npm
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

找到3个进程：

运行中：
#1  npm test           (04:15 运行中)
#2  npm run build      (05:23 运行中)
#5  npm run dev        (02:45 运行中)

已完成：
#4  npm install        (完成，退出代码0)
```

### 按状态过滤

```
User: /bashes --status running

Claude Code: 运行中的进程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌────┬────────────────┬──────────┬────────┐
│ ID │ 命令           │ 运行时间 │ CPU    │
├────┼────────────────┼──────────┼────────┤
│ 1  │ npm test       │ 04:15    │ 45%    │
│ 2  │ npm run build  │ 05:23    │ 23%    │
│ 3  │ docker-compose │ 15:45    │ 12%    │
│ 5  │ npm run dev    │ 02:45    │ 8%     │
└────┴────────────────┴──────────┴────────┘

总计：4个运行中的进程
总 CPU：88%
```

## 清理

### 清除已完成进程

```
User: /bashes clean

Claude Code: 清除已完成进程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

已完成进程：
#4  npm install       (成功)
#5  git clone         (成功)
#6  npm test          (成功)
#7  npm run build     (失败，代码1)

总计：4个

清除操作将：
- 从列表中删除进程
- 保留已保存的日志
- 释放内存

清除所有已完成进程？（y/n）

User: y

✓ 清除4个进程
✓ 释放23 MB
```

### 自动清理

```
User: /bashes config

Claude Code: Bashes 配置
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

自动清理：
[✓] 成功进程后自动清理
[ ] 失败进程后自动清理
[✓] 保留最后10个进程
[✓] 30天后删除日志

通知：
[✓] 启用桌面通知
[✓] 完成时通知
[✓] 错误时通知

输出：
最大缓冲区大小：10 MB
自动滚动：启用
语法高亮：启用

保存更改？（y/n）
```

## 故障排除

### 进程挂起

```
User: /bashes output 1

[无新输出15分钟]

User: 进程1看起来挂起了

Claude Code: 诊断进程 #1
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

命令：npm test
PID：12345
运行时间：25:00（无新输出15分钟）

诊断：
✓ 进程仍在运行
✓ 未使用 CPU（0%）
✓ 内存稳定（234 MB）
⚠ 无最近输出

可能原因：
- 等待输入
- 死锁
- 无限循环
- 等待网络

选项：
[1] 发送中断（Ctrl+C）
[2] 终止进程
[3] 等待更长时间
[4] 查看 strace 输出

User: 1

[发送 SIGINT]
✓ 进程响应并退出
```

### 缺失输出

```
User: /bashes output 3

Claude Code: 进程 #3 输出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

警告：未捕获输出

进程：docker compose up
PID：12347

问题：此进程在输出捕获之前启动

解决方案：
1. 连接到进程 stdout：
   tail -f /proc/12347/fd/1

2. 检查 Docker logs：
   docker compose logs -f

3. 下次在捕获启用的情况下重新启动
```

## 最佳实践

### 1. 监控长时间运行进程

```
✓ 使用 /bashes 跟踪进度
✓ 启用通知以获得完成警报
✓ 定期检查资源使用情况
✓ 将日志导出以进行审计
```

### 2. 清理已完成进程

```
✓ 定期使用 /bashes clean
✓ 启用自动清理
✓ 导出重要日志
✓ 保持列表易于管理
```

### 3. 处理错误

```
✓ 为失败启用错误通知
✓ 检查退出代码
✓ 审查错误日志
✓ 导出输出以进行调试
```

## 相关命令

- `/hooks` - 触发后台进程
- `/agents` - 运行代理作为后台任务
- `/config` - 配置进程设置
- `/export` - 导出会话包括进程

## 提示

- 使用 `/bashes` 监控长时间运行命令
- 启用通知以在进程完成时获得警报
- 定期清除已完成进程
- 导出重要日志以进行记录
- 使用过滤器查找特定输出
- 监控资源使用以避免问题
- 优雅地终止进程（SIGTERM）而不是强制终止（SIGKILL）

## 常见问题

**Q：我可以重新连接到进程吗？**
A：是的，使用 `/bashes output <id>` 查看任何进程的输出。

**Q：输出存储在哪里？**
A：在内存中，直到清除或导出到磁盘。

**Q：输出大小有限制吗？**
A：是的，默认为10 MB。旧输出会自动丢弃。

**Q：我可以向进程发送输入吗？**
A：不可以，后台进程是只读的。使用交互式终端。

**Q：进程何时自动清理？**
A：当配置为自动清理或手动使用 `/bashes clean` 时。

**Q：我可以在会话之间保留进程吗？**
A：不可以，进程绑定到 Claude Code 会话。会话结束时它们会终止。

**Q：当 Claude Code 退出时进程会发生什么？**
A：它们会被优雅地终止（SIGTERM）。
